# 图片去水印项目 - 复盘文档

> 最后更新：2025-12-26（新增自动检测预览 + 可拖拽调整水印区域）
> 目的：记录项目背景、问题分析、解决方案，方便后续优化

---

## 一、项目背景

### 1.1 项目目标
开发一个本地 Web 应用「小白AI图片去水印」，面向新手用户，提供简单易用的图片水印去除功能。

### 1.2 技术栈
- **后端**: FastAPI + Python
- **图像处理**: OpenCV + Pillow + NumPy
- **前端**: 纯 HTML/CSS/JS
- **端口**: 默认 9000（支持自动切换）

### 1.3 项目路径
```
F:\CursorCode_all\图片去水印\
```

---

## 二、水印特征分析

### 2.1 水印精确位置（基于 1024x1024 图片分析）

通过对比原图和理想效果图的像素差异得出：

| 参数 | 数值 |
|------|------|
| 水印边界框 | (924, 919) 到 (1018, 1022) |
| 水印大小 | 94 x 103 像素 |
| 距右边缘 | 6 像素 |
| 距下边缘 | 2 像素 |
| 受影响像素 | 约 4024 个 |

### 2.2 水印视觉特征
- **形状**: 四角星形（类似 ✦）
- **颜色**: 浅灰色/半透明白色
- **特点**: 比背景略亮，有明显边缘
- **背景**: 木地板纹理

### 2.3 分析脚本
```python
# 位置: 图片去水印/analyze_diff.py
# 用途: 对比原图和理想效果，精确定位水印
```

---

## 三、遇到的问题

### 3.1 端口占用问题
- **现象**: 启动服务时发现 9000 端口被别的程序占用
- **原因**: `file_server.py --port 9000` 的主进程和子进程占用
- **解决**: 杀掉父进程 60892 后，还需杀掉子进程 15432

### 3.2 虚拟环境激活失败
- **现象**: `".\venv\Scripts\activate"` 无效
- **原因**: PowerShell 中加了引号变成字符串
- **解决**: 使用 `.\venv\Scripts\Activate.ps1`

### 3.3 早期去水印效果差
- **问题1**: 水印没去掉
- **问题2**: 背景颜色变浅了
- **原因**: 
  - 检测范围太大（15% → 应该是 ~10%）
  - 检测逻辑太复杂，反而检测不到半透明水印
  - 处理了不该处理的区域

---

## 四、最终解决方案

### 4.1 核心思路

参考 [EzRemove](https://ezremove.ai/zh/watermark-remover/) 的方法：
1. **精确定位**: 使用固定参数定位水印区域
2. **纹理采样**: 从水印上方采样相同纹理填充
3. **Inpainting**: 使用 OpenCV TELEA 算法平滑
4. **羽化混合**: 使用高斯模糊 mask 平滑过渡

### 4.2 关键代码参数

```python
# main.py 中的水印参数（针对此类水印优化）
wm_width = 96      # 水印宽度
wm_height = 105    # 水印高度
margin_right = 6   # 距右边缘
margin_bottom = 2  # 距下边缘
```

### 4.3 处理流程

```
原图 → 创建水印 mask → 纹理采样填充 → Inpainting → 羽化混合 → 输出
```

### 4.4 效果验证
- **与理想效果的平均差异**: 0.12（几乎完美）
- **其他区域**: 完全不变

---

## 五、关键文件说明

| 文件 | 说明 |
|------|------|
| `main.py` | FastAPI 主程序，包含去水印算法 |
| `index.html` | 前端页面 |
| `analyze_diff.py` | 分析原图和理想效果的差异 |
| `test_final.py` | 测试最终算法效果 |
| `测试用的图片/` | 测试图片目录 |
| `测试用的图片/原始的带有星星水印的图片.png` | 原始有水印图片 |
| `测试用的图片/理想的处理后的图片.png` | 理想效果（ezremove 处理的） |

---

## 六、LaMa AI 模型集成（2025-12-25 新增）

### 6.1 集成背景
原 OpenCV 方案去水印后效果模糊，有明显修补痕迹。现已集成 LaMa (Large Mask Inpainting) AI 模型，效果大幅提升。

### 6.2 效果对比

| 方案 | 平均差异（与理想效果对比） | 评级 |
|------|---------------------------|------|
| OpenCV (纹理采样 + inpainting) | 12.52 | GOOD |
| **LaMa AI** | **7.56** | **EXCELLENT** |

**LaMa 效果比 OpenCV 好约 40%！**

### 6.3 技术细节

- **模型**: `simple-lama-inpainting` 包
- **模型文件**: `big-lama.pt` (~196MB)
- **模型位置**: `项目目录/models/big-lama.pt`（本地化，方便打包部署）
- **备用位置**: `~/.cache/torch/hub/checkpoints/big-lama.pt`（如本地不存在会自动下载）
- **运行设备**: CPU（已解决 CUDA 兼容性问题）
- **处理速度**: 单张 1024x1024 图片约 2-5 秒

### 6.4 关键代码修改

```python
# main.py 中的关键修改

# 1. 在导入 torch 之前设置环境变量
os.environ['CUDA_VISIBLE_DEVICES'] = ''

# 2. 使用 map_location='cpu' 加载模型
model = torch.jit.load(model_path, map_location='cpu')

# 3. 使用 torch.inference_mode() 进行推理
with torch.inference_mode():
    inpainted = _lama_model(img_tensor, mask_tensor)
```

### 6.5 相关测试文件

| 文件 | 说明 |
|------|------|
| `test_lama.py` | LaMa 模型单独测试 |
| `test_compare.py` | OpenCV vs LaMa 效果对比 |
| `compare_opencv_result.png` | OpenCV 处理结果 |
| `compare_lama_result.png` | LaMa 处理结果 |

---

## 七、手动标记功能（2025-12-25 新增）

### 7.1 功能说明
参考 [EzRemove](https://ezremove.ai/zh/watermark-remover/) 的设计，添加了手动标记水印区域的功能。

### 7.2 两种模式

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| **自动模式** 🤖 | 使用固定参数定位右下角水印 | 水印位置固定的图片 |
| **手动擦除** 🖌️ | 用画笔标记需要去除的区域 | 任意位置的水印 |

### 7.3 画笔工具功能
- **画笔大小调节**: 5px - 100px
- **画笔工具**: 标记需要去除的区域（红色高亮显示）
- **橡皮擦工具**: 擦除误标记的区域
- **清除标记**: 一键清除所有标记
- **触摸屏支持**: 支持移动设备触摸操作

### 7.4 技术实现
- **前端**: Canvas 双层绘制（图片层 + mask 层）
- **后端**: 接收 Base64 编码的 mask 图片
- **处理**: 使用 LaMa 模型修复用户标记的区域

### 7.5 Bug 修复记录

#### 画笔定位偏移问题（已修复）
- **现象**: 画笔标记位置与鼠标位置不一致，偏移较大
- **原因分析**:
  1. Canvas 使用 flex 居中布局，但 maskCanvas 使用 `position: absolute` 相对于父容器定位
  2. maskCanvas 和 imageCanvas 位置不同步
  3. Canvas 的显示尺寸和内部绘图尺寸可能不一致
- **解决方案**:
  1. 添加 `.canvas-container` 容器包裹两个 Canvas，确保 maskCanvas 正确叠加
  2. 修复坐标计算，考虑缩放比例：
     ```javascript
     const scaleX = imageCanvas.width / rect.width;
     const scaleY = imageCanvas.height / rect.height;
     return { x: x * scaleX, y: y * scaleY };
     ```
  3. Canvas 尺寸取整避免模糊
  4. 添加坐标边界检查

#### 手动模式处理后图片全黑问题（已修复）
- **现象**: 使用手动模式标记水印后，处理结果图片完全是黑色/深色
- **原因分析**:
  1. `getMaskDataURL()` 函数中，将 maskCanvas 绘制到黑色背景后，检查的是 alpha 通道
  2. 但绘制到不透明黑色背景后，**所有像素的 alpha 都是 255**
  3. 导致整个 mask 都变成白色，LaMa 尝试修复整张图片
- **解决方案**:
  改为检查 **RGB 颜色通道**而非 alpha 通道：
  ```javascript
  // 检查红色通道（画笔是红色 rgba(255, 0, 0, 0.5)）
  const r = data.data[i];
  const g = data.data[i + 1];
  const b = data.data[i + 2];
  
  // 如果有颜色成分（画笔标记的区域），设置为白色
  if (r > 20 || g > 20 || b > 20) {
      data.data[i] = 255;     // 白色 - 需要修复
      data.data[i + 1] = 255;
      data.data[i + 2] = 255;
  } else {
      data.data[i] = 0;       // 黑色 - 保留原图
      data.data[i + 1] = 0;
      data.data[i + 2] = 0;
  }
  ```

---

## 八、前端界面美化（2025-12-25 新增）

### 8.1 配色方案优化

参考 [EzRemove](https://ezremove.ai/zh/watermark-remover/) 的设计风格，将配色从刺眼的黄色改为护眼的专业蓝紫色调。

#### 配色对比

| 元素 | 原配色 | 新配色 |
|------|--------|--------|
| **背景** | 刺眼黄色 `#F5C842` | 柔和灰白渐变 `#f8fafc → #e2e8f0` |
| **主色调** | 橙色 `#E8941A` | 靛蓝紫色 `#6366f1` |
| **强调色** | 深橙 `#D4790F` | 深紫色 `#4f46e5` |
| **按钮渐变** | 橙色渐变 | 蓝紫渐变 `#6366f1 → #8b5cf6` |
| **悬停背景** | 暖黄 `#FFF8E7` | 淡蓝 `#f0f4ff` |

#### 护眼特点
- ✅ 浅灰白背景，减少眼睛疲劳
- ✅ 蓝紫色调，更专业现代
- ✅ 低对比度渐变，不刺眼
- ✅ 符合主流 SaaS 产品设计规范

### 8.2 浏览器图标（Favicon）

添加了 SVG 格式的浏览器标签图标：
- 紫色渐变圆角背景 (`#6366f1 → #8b5cf6`)
- 白色星星 ✨ 图标
- 与页面整体风格一致
- 使用 Data URI 内嵌，无需额外文件

```html
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,...">
```

### 8.3 标题优化

- 标题文字：`小白AI图片去水印`（2025-12-26 更新，更适合新手用户）
- 浏览器标题：`小白AI图片去水印`
- 图标：使用 ✨ emoji 替代图片文件
- 布局：flexbox 居中对齐

---

## 九、自动检测预览 + 可调整区域（2025-12-26 新增）

### 9.1 功能背景

原自动模式使用固定参数（96x105像素）检测水印，对于较大或位置不同的水印会覆盖不完全。新增功能让用户可以：
1. **预览检测结果**：上传图片后先显示检测到的水印区域
2. **调整区域大小**：拖拽边框边缘调整覆盖范围
3. **确认后处理**：用户确认区域正确后再执行去水印

### 9.2 新增 API

#### `/api/detect-watermark` (POST)
检测水印位置，返回区域坐标供前端预览。

**请求**: `multipart/form-data`，包含图片文件

**响应**:
```json
{
  "success": true,
  "image_size": {"width": 1024, "height": 1024},
  "watermark_region": {
    "x1": 922, "y1": 917,
    "x2": 1018, "y2": 1022,
    "width": 96, "height": 105
  },
  "message": "水印区域检测完成"
}
```

#### `/api/remove-watermark` 更新
新增 `custom_region` 参数，支持用户自定义水印区域坐标。

### 9.3 前端交互设计

#### 可拖拽水印框
- **移动**：拖拽边框中心区域移动位置
- **调整大小**：拖拽 8 个角/边手柄调整尺寸
- **实时显示**：底部显示当前区域尺寸（原始像素）
- **边界限制**：不允许超出图片边界

#### 手柄位置
```
┌──[TL]────[T]────[TR]──┐
│                       │
[L]    拖拽调整区域    [R]
│                       │
└──[BL]────[B]────[BR]──┘
```

### 9.4 技术实现

#### CSS 样式（蓝紫色调，与页面风格一致）
```css
/* 可拖拽水印框 */
.watermark-overlay {
    border: 3px solid #8b5cf6;
    background: rgba(139, 92, 246, 0.15);
    border-radius: 8px;
    cursor: move;
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.9), 0 0 20px rgba(139, 92, 246, 0.4);
}

/* 标签使用渐变 */
.watermark-label {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
}

/* 拖拽手柄 */
.resize-handle {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    border: 2px solid white;
    border-radius: 4px;
}
```

#### JavaScript 核心逻辑
```javascript
// 拖拽状态
let isDragging = false;
let isResizing = false;
let currentResizeHandle = null;

// 更新自定义区域（转换为原始坐标）
function updateCustomWatermarkRegion() {
    const scaleX = imageObj.width / imageCanvas.width;
    const scaleY = imageObj.height / imageCanvas.height;
    
    customWatermarkRegion = {
        x1: Math.round(parseFloat(overlay.style.left) * scaleX),
        y1: Math.round(parseFloat(overlay.style.top) * scaleY),
        // ... width, height, x2, y2
    };
}
```

#### 后端处理
```python
def remove_watermark_with_custom_region(image, region):
    """使用用户自定义的水印区域去除水印"""
    x1 = max(0, int(region.get('x1', 0)))
    y1 = max(0, int(region.get('y1', 0)))
    x2 = min(width, int(region.get('x2', width)))
    y2 = min(height, int(region.get('y2', height)))
    
    # 创建 mask 并使用 LaMa 处理
    mask_array[y1:y2, x1:x2] = 255
    # ...
```

### 9.5 用户体验流程

```
1. 选择"自动模式" → 上传图片
2. 系统自动检测水印位置，显示紫色边框标记
3. 用户可拖拽/调整边框（适应不同大小的水印）
4. 确认后点击"开始去水印"
5. AI 处理完成，显示对比结果
```

### 9.6 解决的问题

| 问题 | 解决方案 |
|------|----------|
| 固定参数覆盖不全 | 用户可拖拽调整区域大小 |
| 水印位置不同 | 用户可移动边框位置 |
| 无法预览处理区域 | 上传后先显示检测结果 |
| 误操作 | 需用户确认后才处理 |

### 9.7 Bug 修复：重置时中止进行中的任务

- **现象**：如果有任务正在进行（检测或处理），点击重置按钮后任务仍在后台运行
- **原因**：fetch 请求没有被取消，继续执行直到完成
- **解决方案**：
  1. 使用 `AbortController` 控制请求
  2. 重置时调用 `abort()` 中止进行中的请求
  3. 处理 `AbortError` 异常，避免显示错误提示

```javascript
// 中止当前进行中的请求
let currentAbortController = null;

function abortCurrentRequest() {
    if (currentAbortController) {
        currentAbortController.abort();
        currentAbortController = null;
    }
}

// 在 fetch 请求中使用
currentAbortController = new AbortController();
const response = await fetch('/api/xxx', {
    signal: currentAbortController.signal
});
```

### 9.8 UI 颜色美化

水印标记框颜色从红色改为蓝紫色调，与页面整体风格一致：

| 元素 | 原颜色 | 新颜色 |
|------|--------|--------|
| 边框 | `#ef4444` (红色) | `#8b5cf6` (紫色) |
| 背景 | `rgba(239,68,68,0.15)` | `rgba(139,92,246,0.15)` |
| 标签/手柄 | 红色纯色 | 蓝紫渐变 `#6366f1 → #8b5cf6` |

---

## 十、打包发布（2025-12-26 新增）

### 10.1 打包方案

使用 PyInstaller 将程序打包为 Windows exe，减少杀毒误报的措施：
- 不使用 `--onefile` 模式（单文件更容易被误报）
- 不使用 UPX 压缩（`--noupx`）
- 添加版本信息文件

### 10.2 相关文件

| 文件 | 说明 |
|------|------|
| `launcher.py` | 启动器，双击运行自动打开浏览器 |
| `build_exe.py` | 打包脚本，一键生成 exe |
| `GITHUB_GUIDE.md` | GitHub 仓库创建和发布指南 |
| `.gitignore` | Git 忽略文件配置 |

### 10.3 打包步骤

```powershell
# 1. 激活虚拟环境
.\venv\Scripts\Activate.ps1

# 2. 安装 PyInstaller
pip install pyinstaller

# 3. 运行打包脚本
python build_exe.py

# 4. 打包结果在 dist/小白AI图片去水印/ 目录
```

### 10.4 发布到 GitHub

详见 `GITHUB_GUIDE.md`，主要步骤：
1. 创建 GitHub 仓库
2. 推送源代码
3. 打包 exe 并压缩
4. 创建 Release 并上传 zip

### 10.5 安全提醒

⚠️ **不要在代码或对话中分享 GitHub Token！**
- Token 一旦暴露应立即撤销
- 使用环境变量或 Git 凭据管理器存储

---

## 十一、待优化方向

### 11.1 当前方案的局限
1. ~~**固定参数**: 水印位置和大小是写死的~~ ✅ 已通过可调整区域解决
2. ~~**纹理采样**: 对于复杂背景可能效果不够好~~ ✅ 已通过 LaMa 解决
3. ~~**无法预览检测区域**~~ ✅ 已通过自动检测预览解决
4. **首次加载慢**: LaMa 模型首次加载需要几秒钟

### 11.2 可能的优化方向

#### ~~方向1: 让用户预览和调整检测区域~~ ✅ 已完成（2025-12-26）

#### 方向2: AI 智能检测水印位置
- 使用深度学习模型自动识别水印边界
- 自适应不同类型的水印

#### ~~方向3: LaMa 模型~~ ✅ 已完成

#### ~~方向4: 让用户手动标记~~ ✅ 已完成

---

## 十二、常用命令

### 12.1 启动服务
```powershell
cd F:\CursorCode_all\图片去水印
.\venv\Scripts\Activate.ps1
python main.py
```

### 12.2 访问地址
```
http://127.0.0.1:9000
```

### 12.3 检查端口占用
```powershell
netstat -ano | findstr ":9000"
Get-Process -Id <PID>
```

### 12.4 杀掉占用端口的进程
```powershell
Stop-Process -Id <PID> -Force
```

### 12.5 安装依赖
```powershell
.\venv\Scripts\Activate.ps1
pip install --only-binary :all: scipy opencv-python
```

---

## 十三、参考资料

- [EzRemove - 免费AI去水印](https://ezremove.ai/zh/watermark-remover/)
- [OpenCV Inpainting](https://docs.opencv.org/4.x/df/d3d/tutorial_py_inpainting.html)
- [LaMa Inpainting](https://github.com/advimman/lama)

---

## 十四、下一步建议

1. **日常使用**:
   - 自动模式：上传图片后会显示检测区域预览，可拖拽调整边框大小和位置
   - 手动模式：适合任意位置水印，用画笔标记即可

2. **处理较大水印**:
   - 上传图片后，拖拽边框边角放大覆盖区域
   - 确保边框完全覆盖水印后再点击处理

3. **性能优化**:
   - LaMa 模型首次加载约 3-5 秒
   - 后续处理每张图片约 2-3 秒
   - 可考虑预加载模型或使用 GPU 加速

4. **功能扩展方向**:
   - AI 智能检测水印边界（自动识别水印大小）
   - 批量处理多张图片
   - 视频去水印支持

---

*复盘完成，下次开启新窗口时读取此文件即可快速了解项目背景。*

*最后更新：2025-12-26*

